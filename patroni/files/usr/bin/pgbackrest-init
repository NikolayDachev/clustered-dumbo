#!/bin/bash
PGBACKREST=/usr/bin/pgbackrest
STANZA="$1"
PGDATADIR="$2"
PGBACKREST_INIT_DONE="${PGDATADIR}/pgbackrest-stanza-created"

if ! [ -e "${PGBACKREST_INIT_DONE}" ] ; then
  if ${PGBACKREST} info | grep -q "No stanzas exist in the repository." ; then
    ${PGBACKREST} stanza-create --stanza="${STANZA}"
    touch "${PGBACKREST_INIT_DONE}"
    if ${PGBACKREST} info | grep -q "no valid backups" ; then
      ${PGBACKREST} backup --stanza="${STANZA}"
    fi
  fi
fi
