#
# clustered-dumbo
#
# Copyright (C) 2025   darix
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

#!/bin/bash
PGBACKREST=/usr/bin/pgbackrest
STANZA="$1"
PGDATADIR="$2"
PGBACKREST_INIT_DONE="${PGDATADIR}/pgbackrest-stanza-created-${STANZA}"

if [ "x${STANZA}" = "x" ]; then
  echo "stanza can not be empty"
  exit 1
fi

if [ "x${PGDATADIR}" = "x" ]; then
  echo "pg datadir can not be empty"
  exit 1
fi

if ! [ -e "${PGBACKREST_INIT_DONE}" ] ; then
  if ${PGBACKREST} info | grep -q "No stanzas exist in the repository." ; then
    ${PGBACKREST} stanza-create --stanza="${STANZA}"
    touch "${PGBACKREST_INIT_DONE}"
    if ${PGBACKREST} info | grep -q "no valid backups" ; then
      ${PGBACKREST} backup --stanza="${STANZA}"
    fi
  fi
fi
